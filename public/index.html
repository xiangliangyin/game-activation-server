<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿€æ´»ç ç³»ç»Ÿ</title>
    <style>
        body { font-family: Arial; max-width: 800px; margin: 0 auto; padding: 20px; }
        .card { background: #f5f5f5; padding: 20px; border-radius: 10px; margin: 20px 0; }
        input[type="text"] { width: 300px; padding: 10px; font-size: 16px; margin-right: 10px; }
        button { padding: 10px 20px; background: #0070f3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0051bb; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #eee; padding: 10px; border-radius: 5px; overflow: auto; }
    </style>
</head>
<body>
    <h1>ğŸ”‘ æ¿€æ´»ç ç³»ç»Ÿ</h1>
    
    <div class="card">
        <h3>ç³»ç»ŸçŠ¶æ€</h3>
        <div id="systemStatus">æ£€æŸ¥ä¸­...</div>
        <button onclick="checkSystem()">åˆ·æ–°çŠ¶æ€</button>
    </div>
    
    <div class="card">
        <h3>æ¿€æ´»æµ‹è¯•</h3>
        <input type="text" id="codeInput" placeholder="è¾“å…¥20ä½æ¿€æ´»ç ">
        <button onclick="activateCode()">æµ‹è¯•æ¿€æ´»</button>
        <div id="activateResult" style="margin-top: 10px;"></div>
    </div>
    
    <div class="card">
        <h3>APIæµ‹è¯•</h3>
        <button onclick="testAPI()">æµ‹è¯•æ‰€æœ‰API</button>
        <pre id="apiResult"></pre>
    </div>
    
    <script>
        // è‡ªåŠ¨è·å–å½“å‰åŸŸå
        const API_BASE = window.location.origin;
        console.log('APIåœ°å€:', API_BASE);
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            checkSystem();
        });
        
        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystem() {
            document.getElementById('systemStatus').innerHTML = 'æ£€æŸ¥ä¸­...';
            
            try {
                const response = await fetch(API_BASE + '/api/status');
                const data = await response.json();
                
                if (data.ok) {
                    document.getElementById('systemStatus').innerHTML = `
                        âœ… ç³»ç»Ÿæ­£å¸¸<br>
                        æ€»æ¿€æ´»ç : ${data.stats.total.toLocaleString()}<br>
                        å·²ä½¿ç”¨: ${data.stats.used.toLocaleString()}<br>
                        å¯ç”¨: ${data.stats.available.toLocaleString()}
                    `;
                } else {
                    document.getElementById('systemStatus').innerHTML = 'âŒ ç³»ç»Ÿå¼‚å¸¸';
                }
            } catch (error) {
                document.getElementById('systemStatus').innerHTML = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
            }
        }
        
        // æ¿€æ´»æµ‹è¯•
        async function activateCode() {
            const code = document.getElementById('codeInput').value.trim();
            const resultDiv = document.getElementById('activateResult');
            
            if (!code || code.length !== 20) {
                resultDiv.innerHTML = '<span class="error">âŒ è¯·è¾“å…¥20ä½æ¿€æ´»ç </span>';
                return;
            }
            
            resultDiv.innerHTML = 'éªŒè¯ä¸­...';
            
            try {
                const response = await fetch(API_BASE + '/api/activate?code=' + encodeURIComponent(code));
                const data = await response.json();
                
                if (data.ok) {
                    resultDiv.innerHTML = `
                        <span class="success">âœ… æ¿€æ´»æˆåŠŸï¼</span><br>
                        æ¿€æ´»ç : ${data.code}<br>
                        æ—¶é—´: ${new Date(data.used_at).toLocaleString()}
                    `;
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    document.getElementById('codeInput').value = '';
                    // åˆ·æ–°çŠ¶æ€
                    setTimeout(checkSystem, 1000);
                } else {
                    resultDiv.innerHTML = `<span class="error">âŒ ${data.error}</span>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</span>`;
            }
        }
        
        // æµ‹è¯•API
        async function testAPI() {
            const resultDiv = document.getElementById('apiResult');
            resultDiv.textContent = 'æµ‹è¯•ä¸­...';
            
            const endpoints = [
                { name: 'å¥åº·æ£€æŸ¥', url: '/api/health' },
                { name: 'çŠ¶æ€', url: '/api/status' },
                { name: 'ç¯å¢ƒ', url: '/api/env' }
            ];
            
            let results = [];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(API_BASE + endpoint.url);
                    const data = await response.json();
                    results.push({
                        æ¥å£: endpoint.name,
                        çŠ¶æ€: response.status,
                        æ•°æ®: data
                    });
                } catch (error) {
                    results.push({
                        æ¥å£: endpoint.name,
                        é”™è¯¯: error.message
                    });
                }
            }
            
            resultDiv.textContent = JSON.stringify(results, null, 2);
        }
        
        // å¯¼å‡ºå‡½æ•°
        window.checkSystem = checkSystem;
        window.activateCode = activateCode;
        window.testAPI = testAPI;
    </script>
</body>
</html>
